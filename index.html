<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Time Wars</title>
		<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
		<script src="https://code.jquery.com/ui/1.10.1/jquery-ui.min.js"></script>
		<script src="http://getbootstrap.com/dist/js/bootstrap.min.js"></script>
		
		<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
		<link href="design/style.css" rel="stylesheet">
        <script src="/socket.io/socket.io.js"></script>

    </head>
 
    <body>
	
		<div id="right_panel"><h2>Score board :</h2>Fox : 42 points</div>
		
        <h1>Time Wars <span class="pseudo"></span></h1>

		<table id="map"></table>
		
		<div id="consolebox">
			<p id="log"></p>
		</div>
		
		<div id="version">Alpha</div>

		<script type="text/javascript">

		
			/*
				Socket connection
			*/

            //var socket = io.connect('http://192.168.0.1:8080');
            var socket = io.connect('http://localhost:8080');
			
			/*
				Player Authentication by prompt
			*/
			var byDefaultNickname = getQuerystring('nickname');
			
			var playerNickname = prompt('Welcome to the Arena, Time Lord, what is your Name ?',byDefaultNickname);
			var cellule = -1;
			
			socket.emit('player_authentication', playerNickname);
			
			socket.on('player_created',function(infos){
				playerNickname = infos.moi.pseudo;
				playerCell = infos.cellule;
				
				$(".pseudo").append(" - "+playerNickname);
			});
			

			
			/* Displaying the map */
			var cellID = 0;
			for(i=0;i<5;i++)
			{
				$("#map").append("<tr id='line"+i+"'>");
				for(j=0;j<5;j++)
				{
					$("#line"+i+"").append("<td id="+cellID+"></td>");
					cellID++;
				}
				$("#map").append("</tr>");
			}

			
			/*
			Player Events
			*/
			
			// Click = Shoot
			$("td").on("click",function(){
				//$("#log").append("Ciblage de la cellule "+ $(this).attr('id') +".<br/>");
				socket.emit('attack', $(this).attr('id'));	
			});
			
			
			/*
			Server Events
			*/
			socket.on('message',function(text){
				$("#log").append(text+"<br/>");
				document.getElementById('consolebox').scrollTop = document.getElementById('consolebox').scrollHeight;
			});
			
			socket.on('load_map',function(joueurs){
				
				// Displays players on the map
				for(i=0; i<25; i++)
				{
					if(joueurs[i] != undefined)
						$("#"+i).html(joueurs[i].pseudo+"<br/>Life : "+joueurs[i].life);
				}

			});
			
			
			
			
			socket.on('new_ennemi',function(infos){
				$("#log").append(infos.ennemi.pseudo+" entered the Arena in position "+infos.cellule+".<br/>");
				$("#"+infos.cellule).html(infos.ennemi.pseudo+"<br/>Life : "+infos.ennemi.life);
			});
			
			socket.on('refresh_ennemi',function(infos){
				$("#"+infos.cellule).html(infos.ennemi.pseudo+"<br/>Life : "+infos.ennemi.life);
			});
			
			socket.on('get_hit',function(infos){ // For each hit, if I'm the target, display it.
				if(infos.cible == playerNickname)
					$("#log").append(infos.agresseur+" hitted you for "+infos.degats+" plasma-years.<br/>");	
					
			});


			socket.on('someone_died', function(infos){
				if(infos.position == playerCell)
				{
					alert(" KABUM ! Game Over ! \n Your time is up. \n We'll remember your name... \n Score : "+infos.mort.score+"");
					
					game_over();
					
				}
				else
				{
					$("#log").append("Lord " + infos.mort.pseudo + " faded away. <br/>");
					$("#"+infos.position).html("");
				}
			});

			
			socket.on('someone_killed', function(infos){
				if(infos.position == cellule)
				{
					alert(" KABUM ! Game Over ! \n Savagely killed par "+infos.pseudo_assassin+" ! \n We'll remember your name... \n Score : "+infos.mort.score+"");
					
					game_over();
					
				}
				else
				{
					$("#log").append("Lord " + infos.mort.pseudo + " has been killed. <br/>");
					$("#"+infos.position).html("");
				}
			});
			
			// called when game is over
			function game_over()
			{
				if (confirm('Do you want to respawn on the Arena ?')) {
					document.location.href="?nickname="+playerNickname;
				} else {
					document.location.href="http://troismots.fr";
				}				
			}
			
			
			// returns the get arguments
		   function getQuerystring(key, default_) {
			   if (default_==null) default_="";
			   key = key.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
			   var regex = new RegExp("[\\?&]"+key+"=([^&#]*)");
			   var qs = regex.exec(window.location.href);
			   if(qs == null) return default_; else return qs[1];
		   }
			
			
        </script>

		<script type="text/javascript">
			
			/*
				Animations and Design
			*/
			
			/* Color animation when hover a cell */
			$("td").mouseenter(function()
			{
				theId = $(this).attr("id");
				if(document.getElementById(theId).textContent.length==0)
				{
					$(this).animate({backgroundColor: "#f0d7fa"}, 150);
				}
				else
				{
					$(this).animate({backgroundColor: "#ffd7f0"}, 150);
				}
			});
			$("td").mouseleave(function()
			{
				$(this).animate({backgroundColor: "#FFFFFF"}, 100);
			});
		</script>
		
		
    </body>
</html>